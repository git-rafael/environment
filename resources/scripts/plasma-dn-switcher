#!/bin/sh

# KDE Plasma Day/Night Theme Switcher
# Alterna entre temas claro e escuro no KDE Plasma

# Configura√ß√µes do tema Day
DAY_COLOR_SCHEME="BreezeLight"
DAY_PLASMA_STYLE="MacSequoia-Light"
DAY_WINDOW_DECORATION="ChromeOS-light"

# Configura√ß√µes do tema Night
NIGHT_COLOR_SCHEME="BreezeDark"
NIGHT_PLASMA_STYLE="MacSonoma-Dark"
NIGHT_WINDOW_DECORATION="ChromeOS-dark"

# Diret√≥rios dos temas
PLASMA_THEMES_DIR="$HOME/.local/share/plasma/desktoptheme"
AURORAE_THEMES_DIR="$HOME/.local/share/aurorae/themes"
COLOR_SCHEMES_DIR="$HOME/.local/share/color-schemes"

# Fun√ß√£o para verificar se temas est√£o instalados
check_themes() {
    missing_themes=false
    
    # Verificar tema Plasma Day
    if [ ! -d "$PLASMA_THEMES_DIR/$DAY_PLASMA_STYLE" ]; then
        echo "‚ö†Ô∏è  Tema do Plasma '$DAY_PLASMA_STYLE' n√£o encontrado"
        missing_themes=true
    fi
    
    # Verificar tema Plasma Night
    if [ ! -d "$PLASMA_THEMES_DIR/$NIGHT_PLASMA_STYLE" ]; then
        echo "‚ö†Ô∏è  Tema do Plasma '$NIGHT_PLASMA_STYLE' n√£o encontrado"
        missing_themes=true
    fi
    
    # Verificar decora√ß√µes das janelas
    if [ ! -d "$AURORAE_THEMES_DIR" ] || [ ! -f "$AURORAE_THEMES_DIR/$DAY_WINDOW_DECORATION/decoration.svg" ]; then
        echo "‚ö†Ô∏è  Decora√ß√£o de janelas '$DAY_WINDOW_DECORATION' n√£o encontrada"
        missing_themes=true
    fi
    
    if [ ! -d "$AURORAE_THEMES_DIR" ] || [ ! -f "$AURORAE_THEMES_DIR/$NIGHT_WINDOW_DECORATION/decoration.svg" ]; then
        echo "‚ö†Ô∏è  Decora√ß√£o de janelas '$NIGHT_WINDOW_DECORATION' n√£o encontrada"
        missing_themes=true
    fi
    
    if [ "$missing_themes" = true ]; then
        echo ""
        echo "üí° Instale os temas ausentes em: Configura√ß√µes do Sistema > Apar√™ncia"
        echo ""
    fi
}

# Fun√ß√£o para aplicar tema Day
apply_day_theme() {
    check_themes
    echo "Aplicando tema Day..."
    
    # Definir esquema de cores
    plasma-apply-colorscheme "$DAY_COLOR_SCHEME"
    
    # Definir estilo do Plasma
    plasma-apply-desktoptheme "$DAY_PLASMA_STYLE"
    
    # Definir decora√ß√£o das janelas
    if command -v qdbus >/dev/null 2>&1; then
        # Modificar kwinrc diretamente
        sed -i "s/theme=__aurorae__svg__.*/theme=__aurorae__svg__${DAY_WINDOW_DECORATION}/" "$HOME/.config/kwinrc"
        # Recarregar configura√ß√£o do KWin
        qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true
        echo "Decora√ß√£o de janelas configurada: $DAY_WINDOW_DECORATION"
    else
        echo "Aviso: qdbus n√£o encontrado, pulando decora√ß√£o das janelas"
    fi
    
    echo "Tema Day aplicado com sucesso!"
}

# Fun√ß√£o para aplicar tema Night
apply_night_theme() {
    check_themes
    echo "Aplicando tema Night..."
    
    # Definir esquema de cores
    plasma-apply-colorscheme "$NIGHT_COLOR_SCHEME"
    
    # Definir estilo do Plasma
    plasma-apply-desktoptheme "$NIGHT_PLASMA_STYLE"
    
    # Definir decora√ß√£o das janelas
    if command -v qdbus >/dev/null 2>&1; then
        # Modificar kwinrc diretamente
        sed -i "s/theme=__aurorae__svg__.*/theme=__aurorae__svg__${NIGHT_WINDOW_DECORATION}/" "$HOME/.config/kwinrc"
        # Recarregar configura√ß√£o do KWin
        qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true
        echo "Decora√ß√£o de janelas configurada: $NIGHT_WINDOW_DECORATION"
    else
        echo "Aviso: qdbus n√£o encontrado, pulando decora√ß√£o das janelas"
    fi
    
    echo "Tema Night aplicado com sucesso!"
}

# Fun√ß√£o para detectar tema atual
get_current_theme() {
    # Verificar esquema de cores atual
    current_colors=$(qdbus org.kde.KWin /ColorCorrect nightColorEnabled 2>/dev/null || echo "false")
    
    # Verificar se est√° usando tema escuro baseado no kwinrc ou plasma
    if grep -q "BreezeDark\|Dark" ~/.config/plasmarc 2>/dev/null || \
       grep -q "dark\|Dark" ~/.config/kwinrc 2>/dev/null; then
        echo "night"
    elif grep -q "BreezeLight\|Light" ~/.config/plasmarc 2>/dev/null || \
         grep -q "light\|Light" ~/.config/kwinrc 2>/dev/null; then
        echo "day"
    else
        # Fallback: verificar se Night Color est√° ativo
        if [ "$current_colors" = "true" ]; then
            echo "night"
        else
            echo "day"
        fi
    fi
}

# Fun√ß√£o para alternar tema
toggle_theme() {
    current_theme=$(get_current_theme)
    
    case "$current_theme" in
        "day")
            apply_night_theme
            ;;
        "night")
            apply_day_theme
            ;;
        *)
            echo "N√£o foi poss√≠vel detectar tema atual. Aplicando tema Day como padr√£o..."
            apply_day_theme
            ;;
    esac
}

# Fun√ß√£o para mostrar uso
show_usage() {
    echo "Uso: $0 [day|night]"
    echo ""
    echo "Comandos:"
    echo "  day     - Aplicar tema claro"
    echo "  night   - Aplicar tema escuro"
    echo ""
    echo "Se nenhum argumento for fornecido, alterna automaticamente entre os temas."
}


# Verificar argumentos
case "${1:-}" in
    "day")
        apply_day_theme
        ;;
    "night")
        apply_night_theme
        ;;
    "help"|"-h"|"--help")
        show_usage
        ;;
    "")
        toggle_theme
        ;;
    *)
        echo "Argumento inv√°lido: $1"
        show_usage
        exit 1
        ;;
esac